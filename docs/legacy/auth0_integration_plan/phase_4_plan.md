# Phase 4 Implementation Plan

| file | op | functions/APIs | tests | perf/mem budget | risk |
| --- | --- | --- | --- | --- | --- | --- |
| server/auth/services.py | add | RevocationService class: add_revocation(token_id, reason), is_revoked(token_id) using persistent Redis sorted set with AOF; monitor write rate | unit: test_add_revocation, test_is_revoked_positive/negative; integration: revoke and auth fail post-restart, high-write throttling | lookup &lt;500us, entry &lt;512B; writes &lt;100/s | Monitored spikes still risk temporary delays |
| server/auth/middleware.py | modify | Integrate cached is_revoked check in verify_token (local TTL 5s + pubsub invalidation); early 403 on match | unit: test_middleware_revoked_token; e2e: revoke active token mid-session, cache invalidation via pubsub | +&lt;50us per request (cache hit) | Pubsub failure delays invalidation |
| server/config/rate_limit.py | modify | Add dynamic per_user_limits dict: {endpoint: {window_s: int, max_req: int}}; admin API to adjust with input validation (positive ints) | unit: test_config_load_per_user, test_dynamic_update, test_validation_rejects_invalid; integration: adjust mid-test | n/a | Validation misses edge cases like zero values |
| server/auth/metadata_limiter.py | create | RateLimiter class: check_limit(user_id, endpoint, now) using Redis sliding window with bounded keys (Lua script + error fallback to deny) | unit: test_check_limit_under/over, test_lua_error_fallback; stress: 1k req/s, key count bounds | check &lt;1ms, counter &lt;1KB/user bounded | Fallback deny over-blocks during Redis issues |
| server/auth/middleware.py | modify | Add rate limit check before auth; 429 on exceed with Retry-After | unit: test_middleware_rate_limit; e2e: burst requests trigger 429 | +&lt;200us per request | Amplifies DoS if not sharded |
| server/auth/circuit_breaker.py | create | CircuitBreaker class: wrap_call(fn, max_fails, reset_s, backoff_fn, min_fails=3) with hysteresis and failure correlation | unit: test_open_on_fail, test_half_open_success/fail; timeout scenarios, transient flake ignore, correlated fail handling | state change &lt;50us, no mem leak | Correlation logic adds complexity, potential miscorrelation |
| server/auth/providers/auth0.py | modify | Wrap metadata/jwks fetches in CircuitBreaker; exponential backoff | unit: test_fetch_with_breaker_open; integration: simulate Auth0 outage | fetch &lt;50ms nominal, backoff up to 60s | Extended outage exhausts retries |
| server/auth/metrics.py | modify | Add batched counters: revocations, rate_limits_hit, breaker_opens; histograms: limit_checks_ms, breaker_backoff_s; real-time spike alerts | unit: test_metrics_increment, test_alert_triggers; verify Prometheus export, batch flush | &lt;10us per metric with batching; alerts &lt;1s latency | Alert false positives from noise |
| server/auth/utils.py | modify | Add backoff decorator @exponential_backoff(max_tries=5, base=1, max_delay=30, config_via_env=True) for retries | unit: test_backoff_success_after_fail, test_max_tries_exhaust, test_max_delay_cap, test_config_override | retry &lt;100ms total nominal | Env config introduces deployment variance |
| tests/unit/auth/test_middleware.py | add | e2e suite for phase4: revocation mid-flow, rate limit enforcement, breaker resilience, dynamic adjust; real Redis with AOF corruption sim | coverage &gt;90% for new paths | n/a | Increased test runtime from real Redis |
| server/config/config.py | modify | Add env vars: REVOCATION_TTL_S, USER_RATE_WINDOWS, BREAKER_THRESHOLDS, DYNAMIC_LIMIT_API_KEY with type checking (int/float validators) | unit: test_config_validation, test_type_checks_fail_invalid | n/a | Validators reject valid but unexpected formats |
| docs/auth/06-api-endpoints.md | modify | Document 429 responses, revocation API, dynamic limit admin endpoint /auth/limits | manual review | n/a | Docs drift from impl |
